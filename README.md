# Учебный проект на 7 спринт
## Общая информация
Проект состоит из двух приложений:
1. Основное приложение - Витрина интернет-магазина
2. REST API сервис для выполнения платежей и проверки баланса
### ссылка на репозиторий
https://github.com/domovoy9812/yp_spr5.git
### команда для клонирования репозитория
```git clone https://github.com/domovoy9812/yp_spr5.git```
### структура проекта
1. **data** - модуль отвечает за слой доступа к данным
2. **service** - модуль отвечает за слой бизнес-логики
3. **web** - модуль отвечает за слой представления
4. **main** - Spring Boot модуль для основного приложения
5. **rest-api** модуль содержит Spring Boot приложение, содержащее Rest сервис для платежей и проверки баланса
## Требования для запуска и настройка
### Для работы приложения требуется:
1. Java 21 версии
2. Для запуска приложения в контейнере docker требуется:
  * docker (проверено на версии 28.0.4)
  * добавить в файл hosts `127.0.0.1 keycloak`
3. Для локального запуска приложения требуется:
  * запущенный сервер Postgresql 17
    + должна быть создана основная база данных (по умолчанию **bliushtein_yp_sprint5_db**)
    + должен быть создан пользователь для подключения приложения к базе (по умолчанию **bliushtein_yp_sprint5**)
  * запущенный сервер Redis (проверено на версии 7.4.2)
  * запущенный сервер keycloak
### Требуемая конфигурация keycloak
1. Должен быть создан realm с названием dev
  * В нем должна быть создана роль ROLE_SHOP_ADMIN
  * В нем должны быть созданы пользователи с ролью ROLE_SHOP_ADMIN и без нее 
2. В нем должен быть создан клиент c:
  * id=internet_shop
  * client secret должен совпадать со значением в [application.yml](./main/src/main/resources/application.yml)
  * Клиент должен поддерживать авторизацию через client credentials и authorization code flow
### Настройка приложения
#### [application.yml](./main/src/main/resources/application.yml) файл с настройками основного приложения
1. Для локального запуска приложения требуются следующие настройки:

| параметр              | описание                              | значение по умолчанию                                      |
|-----------------------|---------------------------------------|------------------------------------------------------------|
| spring.r2dbc.url      | строка подключения к БД               | r2dbc:postgresql://localhost:5432/bliushtein_yp_sprint5_db |
| spring.r2dbc.username | имя пользователя для подключения к БД | bliushtein_yp_sprint5                                      |
| spring.r2dbc.password | пароль                                | 12345                                                      |
| data.redis.host       | IP адрес Redis сервера                | 127.0.0.1                                                  |
| data.redis.port       | порт Redis сервера                    | 6379                                                       |
| payment-api-url       | URL REST сервиса                      | http://localhost:8081                                      |
| keycloak-url          | URL keycloak сервера                  | http://localhost:8084                                      |
2. Для запуска приложения в контейнере docker данные настройки не требуются и при запуске приложения будут проигнорированы

#### [application.yml](./rest-api/src/main/resources/application.yml) файл с настройками основного приложения
1. Для локального запуска приложения требуются следующие настройки:

| параметр                                             | описание                                  | значение по умолчанию            |
|------------------------------------------------------|-------------------------------------------|----------------------------------|
| spring.security.oauth2.resourceserver.jwt.issuer-uri | URL адрес realm-а dev на keycloak сервере | http://localhost:8084/realms/dev |
2. Для запуска приложения в контейнере docker данные настройки не требуются и при запуске приложения будут проигнорированы
### Настройки безопасности
1. Для аутентификации и авторизации в основном приложении используется keycloak сервер (authorization code flow)
2. Доступ к товарам доступен всем пользователям
3. Доступ к корзине (включая добавление в нее товаров и покупку) и списку заказов доступен всем аутентифицированным пользователям
4. Доступ к страницам и API для добавления товаров доступен пользователям с ролью SHOP_ADMIN
5. REST API сервис также использует keycloak сервер для авторизации (client credentials flow)
### Сборка и запуск
1. Для сборки проекта нужно выполнить команду ```gradlew clean build```
2. Для запуска keycloak сервера в контейнере docker отдельно от основного приложения нужно выполнить команду ```docker compose -f docker-compose-keycloak.yml up -d```
   Этот шаг позволяет выполнить шаги 3 и 4 без локальной установки и дополнительной настройки keycloak сервера
3. Для локального запуска основного приложения нужно выполнить команду ```gradlew main:bootRun```
4. Для локального запуска REST API приложения нужно выполнить команду ```gradlew rest-api:bootRun```
5. Для запуска всего проекта в контейнере docker нужно выполнить команду ```docker compose up -d```
6. После успешного запуска главная страница основного приложения будет доступна по ссылке http://localhost:8080/main
### Загрузка тестовых данных
Чтобы загрузить необходимую конфигурацию в keycloak сервер, а также тестовые данные в БД основного приложения (работает только при запуске всего проекта в контейнере docker), необходимо перед запуском приложения и keycloak сервер перейти в директорию ./pgdata и разархивировать в нее архив pgdata.zip.
Если приложение уже запускалось все содержимое этой директории, кроме архива нужно удалить
В результате при последующем запуске приложения будут загружены тестовые товары и заказы в магазие, а также вся необходимая конфигурация keycloak сервера, включая пользователей user1/user1 и shop_admin/shop_admin. Последний имеет роль ROLE_SHOP_ADMIN.  